---
phase: 02-cli-and-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pyproject_fmt/cli.py
  - tests/test_pyproject_fmt.py
autonomous: true

must_haves:
  truths:
    - "User can run `pyproject_fmt file.toml` and the file is sorted and formatted in-place"
    - "User can run `pyproject_fmt --check file.toml` and get exit 0 (no changes) or exit 1 (changes needed) without modifying the file"
    - "User can run `pyproject_fmt --diff file.toml` and see a colored unified diff of what would change"
    - "User can pipe stdin to `pyproject_fmt` (no file args) and get formatted output on stdout"
    - "User can pass multiple files and all are processed with a single aggregate exit code"
    - "User sees no output on success in fix mode; sees brief summary on stderr when changes are made"
    - "Invalid TOML produces a parse error to stderr and exit non-zero"
    - "File permission errors are reported per-file; remaining files continue processing"
  artifacts:
    - path: "src/pyproject_fmt/cli.py"
      provides: "Typer CLI with fix/check/diff modes, file and stdin I/O, version flag"
      contains: "@app.command"
    - path: "tests/test_pyproject_fmt.py"
      provides: "CLI tests for all modes: fix, check, diff, stdin, multi-file, errors"
      contains: "def test_cli_"
  key_links:
    - from: "src/pyproject_fmt/cli.py"
      to: "src/pyproject_fmt/pipeline.py"
      via: "format_pyproject() call"
      pattern: "format_pyproject"
    - from: "src/pyproject_fmt/cli.py"
      to: "stderr"
      via: "typer.echo(err=True)"
      pattern: "err=True"
    - from: "src/pyproject_fmt/cli.py"
      to: "stdout"
      via: "sys.stdout.write for diff output"
      pattern: "sys\\.stdout"
---

<objective>
Replace the scaffold CLI with the real formatting command supporting fix (in-place default), check (dry-run), and diff (unified diff) modes. Support file arguments, stdin/stdout, multiple files with aggregate exit codes, and correct stream separation (data to stdout, status to stderr).

Purpose: This is the primary user interface -- everything built in Phase 1 becomes usable through this command.
Output: Working `pyproject_fmt` CLI that formats pyproject.toml files, plus comprehensive CLI test suite.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cli-and-configuration/02-CONTEXT.md
@.planning/phases/02-cli-and-configuration/02-RESEARCH.md
@.planning/phases/01-core-pipeline/01-01-SUMMARY.md
@src/pyproject_fmt/cli.py
@src/pyproject_fmt/pipeline.py
@src/pyproject_fmt/config.py
@src/pyproject_fmt/__init__.py
@tests/test_pyproject_fmt.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite cli.py with fix/check/diff modes and file/stdin I/O</name>
  <files>src/pyproject_fmt/cli.py</files>
  <action>
Replace the entire scaffold CLI (hello command, @app.callback version pattern) with a single @app.command() implementing all three modes. Follow the verified Typer 0.21.1 patterns from 02-RESEARCH.md exactly.

**Command signature:**
```python
@app.command()
def main(
    files: Annotated[Optional[list[str]], typer.Argument(help="pyproject.toml files to format")] = None,
    check: Annotated[bool, typer.Option("--check", help="Check if files are formatted, exit non-zero if not")] = False,
    diff: Annotated[bool, typer.Option("--diff", help="Show unified diff of changes")] = False,
    version: Annotated[Optional[bool], typer.Option("--version", "-v", callback=version_callback, is_eager=True)] = None,
):
```

**Mode dispatch:**
- Move version_callback to use `is_eager=True` on the command option (per Pitfall 6 from research).
- If `files is None`: stdin mode -- read `sys.stdin.read()`, format, and:
  - fix: write formatted output to stdout via `typer.echo(result, nl=False)`
  - check: exit 0 if unchanged, exit 1 if changed (no output)
  - diff: print unified diff to stdout, exit 0
  - `--check --diff` combined: print diff to stdout AND exit non-zero if changes needed
- If files given: iterate all files, call `_process_file()` for each, aggregate exit codes with `max()`.

**_process_file(filepath, check, diff) -> int:**
- Read file with `pathlib.Path(filepath).read_text(encoding="utf-8")`
- Call `format_pyproject(text)` from pipeline module
- Catch `tomllib.TOMLDecodeError` -- report parse error with line/column to stderr via `typer.echo(f"error: {filepath}: {e}", err=True)`, return 1
- Catch `PermissionError` and `FileNotFoundError` -- report to stderr, return 1
- Compare `text == result`:
  - If unchanged: return 0 (silent -- locked decision)
  - If changed:
    - fix mode: write result back with `Path(filepath).write_text(result, encoding="utf-8")`, print summary to stderr (e.g., `typer.echo(f"{filepath}: reformatted", err=True)`), return 0
    - check mode: print taplo-style error to stderr (`typer.echo(f"error: {filepath}: not properly formatted", err=True)`), return 1
    - diff mode: call `_print_diff(text, result, filepath)`, return 0
    - check+diff combined: call `_print_diff(text, result, filepath)`, return 1

**_print_diff(original, formatted, filename):**
- Use `difflib.unified_diff()` with `splitlines(keepends=True)` for correct line terminators
- `fromfile=f"a/{filename}"`, `tofile=f"b/{filename}"`
- TTY detection: `use_color = sys.stdout.isatty()`
- If color: apply ANSI codes -- CYAN for headers (---/+++/@@), RED for removals (-), GREEN for additions (+), RESET after each colored line
- Use `sys.stdout.write(line)` for each line (NOT typer.echo, per Pitfall 2 from research)

**Summary messages (per locked decisions):**
- Simple "reformatted" message to stderr when changes are applied in fix mode. Use `typer.echo(f"{filepath}: reformatted", err=True)` rather than counting tables/keys (research recommends starting simple, per Open Question 1).
- Silent on success -- no output at all if file is already formatted.

**Imports needed:**
`from __future__ import annotations`, `import difflib`, `import sys`, `import tomllib`, `from pathlib import Path`, `from typing import Annotated, Optional`, `import typer`, `from pyproject_fmt import __version__`, `from pyproject_fmt.pipeline import format_pyproject`

**ANSI color constants** at module level:
```python
_RED = "\033[31m"
_GREEN = "\033[32m"
_CYAN = "\033[36m"
_RESET = "\033[0m"
```
  </action>
  <verify>
Run `uv run python -c "from pyproject_fmt.cli import app; print('import ok')"` to verify the module loads.
Run `uv run ruff check src/pyproject_fmt/cli.py` to verify lint passes.
Run `uv run python -m pyproject_fmt --version` to verify the CLI entry point works.
  </verify>
  <done>
cli.py contains a single @app.command() with fix/check/diff modes. The hello command and @app.callback pattern are gone. Module imports clean and lint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive CLI test suite</name>
  <files>tests/test_pyproject_fmt.py</files>
  <action>
Replace the existing scaffold tests (test_cli_hello_default, test_cli_hello_with_name) with a comprehensive CLI test suite. Keep `test_version` and `test_cli_version` (update the latter if the version output format changed).

**Test fixtures needed (at module level or via conftest):**

Create a minimal valid pyproject.toml string for testing:
```python
FORMATTED_TOML = '[project]\nname = "test"\n'
UNFORMATTED_TOML = '[project]\nname="test"\n'  # Missing space around =
```

Use `tmp_path` pytest fixture for file-based tests. Write TOML content to temp files, invoke CLI, check results.

**Tests to write (one function each):**

1. `test_cli_fix_reformats_file(tmp_path)` -- Write unformatted TOML to temp file, invoke `app` with `[str(filepath)]`, assert exit_code == 0, assert file content is now formatted, assert "reformatted" in `result.stderr`.

2. `test_cli_fix_already_formatted(tmp_path)` -- Write already-formatted TOML to temp file, invoke `app` with `[str(filepath)]`, assert exit_code == 0, assert file content unchanged, assert result.stderr is empty (silent on success).

3. `test_cli_check_needs_changes(tmp_path)` -- Write unformatted TOML, invoke with `["--check", str(filepath)]`, assert exit_code == 1, assert file content is NOT modified (still unformatted), assert "not properly formatted" in result.stderr.

4. `test_cli_check_already_formatted(tmp_path)` -- Write formatted TOML, invoke with `["--check", str(filepath)]`, assert exit_code == 0, assert no stderr output.

5. `test_cli_diff_shows_changes(tmp_path)` -- Write unformatted TOML, invoke with `["--diff", str(filepath)]`, assert exit_code == 0, assert result.stdout contains "---" and "+++" (unified diff headers), assert file content is NOT modified.

6. `test_cli_diff_no_changes(tmp_path)` -- Write formatted TOML, invoke with `["--diff", str(filepath)]`, assert exit_code == 0, assert result.stdout is empty.

7. `test_cli_check_diff_combined(tmp_path)` -- Write unformatted TOML, invoke with `["--check", "--diff", str(filepath)]`, assert exit_code == 1 (check semantics), assert result.stdout contains diff output.

8. `test_cli_stdin_fix()` -- Invoke with `[]` (no files) and `input=UNFORMATTED_TOML`, assert exit_code == 0, assert result.stdout contains formatted output.

9. `test_cli_stdin_check_needs_changes()` -- Invoke with `["--check"]` and `input=UNFORMATTED_TOML`, assert exit_code == 1.

10. `test_cli_stdin_check_no_changes()` -- Invoke with `["--check"]` and `input=FORMATTED_TOML`, assert exit_code == 0.

11. `test_cli_stdin_diff()` -- Invoke with `["--diff"]` and `input=UNFORMATTED_TOML`, assert exit_code == 0, assert "---" in result.stdout.

12. `test_cli_multiple_files(tmp_path)` -- Create two temp files (one formatted, one not), invoke with both paths, assert exit_code == 0 (fix mode), assert unformatted file is now formatted, assert formatted file unchanged.

13. `test_cli_multiple_files_check(tmp_path)` -- Create two temp files (one formatted, one not), invoke with `["--check", path1, path2]`, assert exit_code == 1 (aggregate: one file needed changes).

14. `test_cli_invalid_toml(tmp_path)` -- Write invalid TOML (`"[invalid\n"`) to temp file, invoke with `[str(filepath)]`, assert exit_code == 1, assert "error" in result.stderr.

15. `test_cli_file_not_found()` -- Invoke with `["nonexistent.toml"]`, assert exit_code == 1, assert "error" in result.stderr.

16. `test_cli_version()` -- Already exists; update if needed to match new version output format. Assert exit_code == 0, assert `__version__` in result.stdout.

**Important notes:**
- Use `from typer.testing import CliRunner` (already imported)
- `runner = CliRunner()` at module level
- For file tests, write content via `tmp_path / "pyproject.toml"` and use `Path.write_text()`/`Path.read_text()` for assertion
- The FORMATTED_TOML and UNFORMATTED_TOML strings must be valid TOML that the real pipeline actually transforms. Test this: run `format_pyproject(UNFORMATTED_TOML) != UNFORMATTED_TOML` and `format_pyproject(FORMATTED_TOML) == FORMATTED_TOML`. If the pipeline transforms FORMATTED_TOML too (e.g., taplo adds trailing newline), adjust the string to be a true fixed point of the pipeline.
- Use the actual `format_pyproject()` function to generate the expected formatted output rather than hardcoding it. This avoids fragile test fixtures.
  </action>
  <verify>
Run `uv run pytest tests/test_pyproject_fmt.py -v` -- all tests pass.
Run `uv run ruff check tests/test_pyproject_fmt.py` -- lint passes.
Run `uv run pytest tests/ -v` -- full suite passes (no regressions in pipeline tests).
  </verify>
  <done>
At least 15 CLI tests pass covering: fix mode (reformats + silent on no-change), check mode (exit codes + no file modification), diff mode (unified diff output), check+diff combined, stdin for all modes, multiple files with aggregate exit code, invalid TOML error, file-not-found error, and version flag. Full test suite (including pipeline tests) has no regressions.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -m pyproject_fmt --version` prints version and exits 0
2. `uv run python -m pyproject_fmt --help` shows usage with files argument, --check, --diff, --version options
3. `uv run python -m pyproject_fmt pyproject.toml` (on project's own pyproject.toml) either reformats or is silent
4. `uv run python -m pyproject_fmt --check pyproject.toml` exits 0 if already formatted, 1 if not
5. `uv run python -m pyproject_fmt --diff pyproject.toml` shows diff or nothing
6. `echo '[project]\nname="test"' | uv run python -m pyproject_fmt` outputs formatted TOML to stdout
7. `uv run pytest tests/ -v` -- all tests pass with no regressions
8. `uv run ruff check src/pyproject_fmt/cli.py tests/test_pyproject_fmt.py` -- clean
</verification>

<success_criteria>
- The scaffold CLI (hello command) is completely replaced by the real formatting command
- All three modes (fix, check, diff) work correctly with both file arguments and stdin
- Multiple files are processed with aggregate exit codes
- Error handling follows locked decisions: parse errors to stderr, permission errors per-file with continue
- Stream separation is correct: data (diff, formatted output) to stdout, status/errors to stderr
- Comprehensive test suite covers all modes, edge cases, and error conditions
- Full project test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-and-configuration/02-01-SUMMARY.md`
</output>
