---
phase: 02-cli-and-configuration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/pyproject_fmt/config.py
  - src/pyproject_fmt/pipeline.py
  - src/pyproject_fmt/cli.py
  - tests/test_config.py
autonomous: true

must_haves:
  truths:
    - "User can add `[tool.pyproject-fmt]` to their pyproject.toml and override default sort/format behavior"
    - "User can use `extend-sort-first` to add items to the default sort_first list without replacing it"
    - "User can use `sort-first` to replace the entire default sort_first list"
    - "User overrides win over hardcoded defaults on conflict"
    - "If both `[tool.tomlsort]` and `[tool.pyproject-fmt]` exist, a warning is printed to stderr"
    - "PPF_HIDE_CONFLICT_WARNING environment variable suppresses the tomlsort conflict warning"
  artifacts:
    - path: "src/pyproject_fmt/config.py"
      provides: "Config loading from [tool.pyproject-fmt], extend/replace merge, conflict detection"
      contains: "def load_config"
    - path: "src/pyproject_fmt/pipeline.py"
      provides: "Pipeline accepts optional config overrides"
      contains: "format_pyproject"
    - path: "tests/test_config.py"
      provides: "Tests for config loading, merging, extend/replace patterns, conflict detection"
      contains: "def test_"
  key_links:
    - from: "src/pyproject_fmt/cli.py"
      to: "src/pyproject_fmt/config.py"
      via: "load_config() call before pipeline"
      pattern: "load_config"
    - from: "src/pyproject_fmt/config.py"
      to: "src/pyproject_fmt/pipeline.py"
      via: "Merged config passed to format_pyproject()"
      pattern: "format_pyproject.*config"
    - from: "src/pyproject_fmt/config.py"
      to: "[tool.pyproject-fmt]"
      via: "tomllib.loads() + dict extraction"
      pattern: 'tool.*pyproject.fmt'
---

<objective>
Add configuration loading from `[tool.pyproject-fmt]` sections in pyproject.toml files, with ruff-style extend/replace merge pattern and tomlsort conflict detection. Wire config loading into the CLI-to-pipeline path so user overrides affect formatting behavior.

Purpose: Users can customize formatting behavior without modifying the tool itself, while the opinionated defaults remain the starting point.
Output: Config loading/merging system with tests, integrated into CLI and pipeline.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cli-and-configuration/02-CONTEXT.md
@.planning/phases/02-cli-and-configuration/02-RESEARCH.md
@.planning/phases/02-cli-and-configuration/02-01-SUMMARY.md
@src/pyproject_fmt/config.py
@src/pyproject_fmt/pipeline.py
@src/pyproject_fmt/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config loading, extend/replace merging, and conflict detection to config.py</name>
  <files>src/pyproject_fmt/config.py</files>
  <action>
Add three new functions to config.py (preserve all existing functions -- they are still the defaults):

**1. `load_config(text: str) -> dict | None`**
- Parse `text` with `tomllib.loads()` to extract `data.get("tool", {}).get("pyproject-fmt", None)`
- If the section doesn't exist, return `None` (no overrides)
- If it does exist, return the raw dict from `[tool.pyproject-fmt]`
- This is a pure extraction -- no merging logic here

**2. `check_config_conflict(text: str) -> str | None`**
- Parse `text` with `tomllib.loads()`
- Check if both `tool.tomlsort` and `tool.pyproject-fmt` exist
- If conflict found AND `os.environ.get("PPF_HIDE_CONFLICT_WARNING")` is NOT set, return the warning message string:
  `"warning: [tool.tomlsort] and [tool.pyproject-fmt] both present. toml-sort should not be used against pyproject.toml files when also using pyproject-fmt, since results and ordering will be outside of pyproject-fmt's control."`
- If no conflict or warning suppressed, return `None`
- The caller (cli.py) is responsible for printing the warning to stderr

**3. `merge_config(user: dict) -> tuple[SortConfiguration, dict[str, SortOverrideConfiguration], CommentConfiguration, FormattingConfiguration, tuple[str, ...]]`**
- Takes the raw dict from `load_config()`, returns merged config objects
- Start with defaults from `get_sort_config()`, `get_sort_overrides()`, `get_comment_config()`, `get_format_config()`, `TAPLO_OPTIONS`
- Apply extend/replace pattern (per locked decisions, modeled on ruff):

  **SortConfiguration fields (via `dataclasses.replace()`):**
  - `sort-first` in user -> replace `first` entirely: `dataclasses.replace(default_sort, first=user["sort-first"])`
  - `extend-sort-first` in user -> extend: `dataclasses.replace(default_sort, first=list(default_sort.first) + user["extend-sort-first"])`
  - `sort-tables` in user -> replace `tables`: `dataclasses.replace(default_sort, tables=user["sort-tables"])`
  - `sort-table-keys` in user -> replace `table_keys`
  - `sort-inline-tables` in user -> replace `inline_tables`
  - `sort-inline-arrays` in user -> replace `inline_arrays`
  - `ignore-case` in user -> replace `ignore_case`

  **SortOverrideConfiguration (per-table overrides):**
  - `overrides` key in user -> dict of table_path -> override dict
  - `extend-overrides` key in user -> merge into default overrides (new keys added, existing keys updated)
  - Each override dict maps to SortOverrideConfiguration fields: `first`, `table_keys`, `inline_arrays`
  - For `overrides` (replace): start fresh from user dict only
  - For `extend-overrides` (extend): copy default overrides dict, then update with user overrides

  **CommentConfiguration:**
  - `comments-header` -> `header`
  - `comments-footer` -> `footer`
  - `comments-inline` -> `inline`
  - `comments-block` -> `block`
  - Apply via `dataclasses.replace()`

  **FormattingConfiguration:**
  - `spaces-before-inline-comment` -> `spaces_before_inline_comment`
  - `spaces-indent-inline-array` -> `spaces_indent_inline_array`
  - `trailing-comma-inline-array` -> `trailing_comma_inline_array`
  - Apply via `dataclasses.replace()`

  **TAPLO_OPTIONS:**
  - `taplo-options` key in user -> replace entire tuple
  - `extend-taplo-options` key in user -> extend: `TAPLO_OPTIONS + tuple(user["extend-taplo-options"])`

- Return the 5-tuple of merged config objects

**Define a module-level mapping dict** to document the TOML-key-to-field correspondence clearly (per Pitfall 3 from research). This serves as documentation and can be referenced in error messages.

**Import additions:** `import dataclasses`, `import os`, `import tomllib` (tomllib may already be imported; add only if missing).

**Do NOT mutate defaults.** Always use `dataclasses.replace()` to create new instances.
  </action>
  <verify>
Run `uv run python -c "from pyproject_fmt.config import load_config, check_config_conflict, merge_config; print('imports ok')"` to verify the module loads.
Run `uv run ruff check src/pyproject_fmt/config.py` to verify lint passes.
  </verify>
  <done>
config.py has three new functions: `load_config()` extracts `[tool.pyproject-fmt]`, `check_config_conflict()` detects tomlsort conflict, `merge_config()` applies extend/replace merging to all config objects. All existing default functions are preserved. Module imports clean and lint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire config loading into pipeline and CLI</name>
  <files>
    src/pyproject_fmt/pipeline.py
    src/pyproject_fmt/cli.py
  </files>
  <action>
**pipeline.py changes:**

Update `format_pyproject()` to accept optional config parameters. The function signature becomes:

```python
def format_pyproject(
    text: str,
    sort_config: SortConfiguration | None = None,
    sort_overrides: dict[str, SortOverrideConfiguration] | None = None,
    comment_config: CommentConfiguration | None = None,
    format_config: FormattingConfiguration | None = None,
    taplo_options: tuple[str, ...] | None = None,
) -> str:
```

- When parameters are `None`, use the existing defaults (call `get_sort_config()` etc.)
- When provided, pass them through to `sort_toml()` and `format_toml()`
- This requires checking whether `sort_toml()` and `format_toml()` accept config parameters. If they don't currently, either:
  (a) Update their signatures to accept optional config, OR
  (b) Have the pipeline call the underlying libraries directly with the config

Check `src/pyproject_fmt/sorter.py` and `src/pyproject_fmt/formatter.py` to see their current signatures and adjust accordingly. The key requirement is that user config overrides reach the toml-sort and taplo invocations.

**cli.py changes:**

In `_process_file()` (the per-file processing function from Plan 02-01):
1. After reading the file content, call `check_config_conflict(text)` -- if it returns a warning string, print it to stderr via `typer.echo(warning, err=True)`
2. Call `load_config(text)` -- if it returns a dict, call `merge_config(user_config)` to get the merged config tuple
3. Pass the merged config (or None for defaults) to `format_pyproject()`

In stdin mode:
1. Same flow: `check_config_conflict()`, `load_config()`, `merge_config()`, then `format_pyproject()` with merged config

**New imports in cli.py:**
```python
from pyproject_fmt.config import check_config_conflict, load_config, merge_config
```

**New imports in pipeline.py:**
```python
from pyproject_fmt.config import (
    get_sort_config, get_sort_overrides, get_comment_config, get_format_config, TAPLO_OPTIONS,
)
```
(Some of these may already be imported via sorter/formatter; check actual state.)
  </action>
  <verify>
Run `uv run pytest tests/ -v` -- all existing tests pass (pipeline tests + CLI tests from 02-01).
Run `uv run ruff check src/pyproject_fmt/` -- all source files pass lint.
Run `uv run python -m pyproject_fmt pyproject.toml` -- still works (no config section present = uses defaults).
  </verify>
  <done>
`format_pyproject()` accepts optional config parameters with defaults. CLI loads config from `[tool.pyproject-fmt]` when present and passes merged config to pipeline. Conflict detection warns when both `[tool.tomlsort]` and `[tool.pyproject-fmt]` exist. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Write config loading and merging test suite</name>
  <files>tests/test_config.py</files>
  <action>
Create a new test file for config loading, merging, and conflict detection. This is a new file (does not conflict with existing test files).

**Tests to write:**

1. `test_load_config_no_section()` -- TOML with no `[tool.pyproject-fmt]` returns `None`
2. `test_load_config_with_section()` -- TOML with `[tool.pyproject-fmt]` section returns the config dict
3. `test_load_config_empty_section()` -- TOML with empty `[tool.pyproject-fmt]` returns empty dict

4. `test_check_conflict_no_conflict()` -- TOML with only `[tool.pyproject-fmt]` returns `None`
5. `test_check_conflict_both_present()` -- TOML with both `[tool.tomlsort]` and `[tool.pyproject-fmt]` returns warning string
6. `test_check_conflict_suppressed(monkeypatch)` -- Set `PPF_HIDE_CONFLICT_WARNING=1` via monkeypatch, TOML with both sections returns `None`
7. `test_check_conflict_only_tomlsort()` -- TOML with only `[tool.tomlsort]` returns `None` (no conflict without pyproject-fmt section)

8. `test_merge_sort_first_replace()` -- User provides `sort-first = ["a", "b"]`, merged config's `first` field is exactly `["a", "b"]` (replaces defaults entirely)
9. `test_merge_sort_first_extend()` -- User provides `extend-sort-first = ["custom-tool"]`, merged config's `first` field is `default.first + ["custom-tool"]`
10. `test_merge_sort_tables_override()` -- User provides `sort-tables = false`, merged config's `tables` is `False`
11. `test_merge_comment_config()` -- User provides `comments-header = false`, merged CommentConfiguration.header is False, other fields unchanged
12. `test_merge_formatting_config()` -- User provides `spaces-indent-inline-array = 2`, merged FormattingConfiguration.spaces_indent_inline_array is 2
13. `test_merge_taplo_options_replace()` -- User provides `taplo-options = ["column_width=120"]`, merged taplo options is exactly that tuple
14. `test_merge_taplo_options_extend()` -- User provides `extend-taplo-options = ["column_width=120"]`, merged taplo options is defaults + `("column_width=120",)`
15. `test_merge_empty_dict()` -- Empty user dict returns all defaults unchanged
16. `test_merge_overrides_extend()` -- User provides `extend-overrides` with a new table path, merged overrides contain both defaults and the new entry
17. `test_merge_overrides_replace()` -- User provides `overrides` dict, merged overrides contain ONLY user-specified entries (defaults replaced)

**Integration test (end-to-end through pipeline):**

18. `test_config_affects_pipeline_output()` -- Create a TOML string with `[tool.pyproject-fmt]` containing `sort-first = ["build-system", "project"]`. Load config, merge, pass to `format_pyproject()`. Verify the output has `[build-system]` before `[project]` (opposite of the default ordering).

**Test patterns:**
- Use plain string TOML fixtures inline (not file-based) for config loading/merging tests
- Use `monkeypatch.setenv()` for environment variable tests
- Import from `pyproject_fmt.config` and `pyproject_fmt.pipeline`
- Compare against default configs from `get_sort_config()` etc. to verify changes
  </action>
  <verify>
Run `uv run pytest tests/test_config.py -v` -- all config tests pass.
Run `uv run ruff check tests/test_config.py` -- lint passes.
Run `uv run pytest tests/ -v` -- full test suite passes with no regressions.
  </verify>
  <done>
At least 17 config tests pass covering: load_config extraction (present/absent/empty), conflict detection (with/without/suppressed), merge_config extend/replace patterns for sort_first, sort overrides, comment config, format config, taplo options, and one end-to-end integration test proving config overrides reach pipeline output. Full suite has no regressions.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from pyproject_fmt.config import load_config, check_config_conflict, merge_config; print('ok')"` -- imports work
2. `uv run pytest tests/test_config.py -v` -- all config tests pass
3. `uv run pytest tests/ -v` -- full suite passes (pipeline + CLI + config tests)
4. `uv run ruff check src/pyproject_fmt/ tests/` -- all files lint clean
5. Create a temp pyproject.toml with `[tool.pyproject-fmt]` containing `extend-sort-first = ["custom"]` -- run `pyproject_fmt` on it, verify it processes without error
6. Create a temp pyproject.toml with both `[tool.tomlsort]` and `[tool.pyproject-fmt]` -- run `pyproject_fmt` on it, verify warning appears on stderr
7. Same as 6 but set `PPF_HIDE_CONFLICT_WARNING=1` -- verify warning is suppressed
</verification>

<success_criteria>
- Config loading extracts `[tool.pyproject-fmt]` from TOML text correctly
- Extend/replace merge pattern works for all config types (sort, overrides, comments, formatting, taplo)
- Conflict detection warns when both [tool.tomlsort] and [tool.pyproject-fmt] present
- PPF_HIDE_CONFLICT_WARNING suppresses the warning
- Pipeline accepts and uses merged config (user overrides affect output)
- All defaults still work when no [tool.pyproject-fmt] section exists
- Comprehensive test suite covers all config paths
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-and-configuration/02-02-SUMMARY.md`
</output>
