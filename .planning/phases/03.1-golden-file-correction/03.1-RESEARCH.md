# Phase 3.1: Golden File Correction - Research

**Researched:** 2026-02-14
**Domain:** toml-sort array sorting, table ordering, pipeline correctness
**Confidence:** HIGH

## Summary

The pipeline produces output that differs from the golden file specification (commit c7e8f30) in three major categories: (1) table ordering, (2) array element sorting, and (3) key ordering within tables. All deviations originate from the toml-sort stage; taplo contributes only comment alignment, which already matches the golden file.

The root causes are:
- **Wrong `sort_first` order** in `config.py`: `project` is listed before `build-system`, but the golden file has `build-system` first. Several `tool.*` entries are also in the wrong order.
- **Global `inline_arrays=True`** sorts ALL array elements alphabetically. The golden file only sorts 3 specific arrays (classifiers, extend-select, ignore). All other arrays must preserve input order.
- **Override key path mismatch**: The override `tool.pytest.addopts` does not match the actual key path `tool.pytest.ini_options.addopts`, so it has no effect.
- **Missing overrides**: Most tables lack `table_keys` overrides, so keys are sorted alphabetically instead of being preserved.

**Primary recommendation:** Set `SortConfiguration.inline_arrays=False` globally, add explicit `inline_arrays=True` overrides only for the 3 arrays that need sorting, fix the `sort_first` list to match the golden file's table order, and fix override key paths.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| toml-sort | 0.24.3 | TOML key/table sorting | Already in use; API supports selective array sorting |
| taplo | 0.9.3 | TOML whitespace/style formatting | Already in use; idempotent on golden file |

## Architecture Patterns

### Pipeline Flow (unchanged)
```
before.toml -> toml-sort (sort) -> taplo (format) -> after.toml
```

Taplo is already correct. All fixes are in the toml-sort configuration.

### Override Key Path Resolution (CRITICAL)

toml-sort resolves overrides using the FULL dotted key path of the item being processed. The `_find_config_override` method checks:
1. Exact match: `keys.as_string() == pattern`
2. Glob match: `fnmatch.fnmatch(keys.as_string(), pattern)`

**Source:** `/home/ubuntulinuxqa2/repos/pyproject-fmt/.venv/lib/python3.14/site-packages/toml_sort/tomlsort.py` lines 282-308

```python
def _find_config_override(self, keys):
    if keys.as_string() in self.sort_config_overrides:
        return self.sort_config_overrides.get(keys.as_string())
    matches = [
        config
        for pattern, config in self.sort_config_overrides.items()
        if fnmatch.fnmatch(keys.as_string(), pattern)
    ]
    if len(matches) > 0:
        return matches[0]
    return None
```

Key implications:
- Override `"test"` does NOT match key path `"test.unsorted"` -- it only matches the table header
- Override `"test.*"` matches `"test.unsorted"` via fnmatch glob
- Override `"test.unsorted"` matches exactly
- For array sorting control, the override must match the ARRAY's key path (e.g., `"project.classifiers"`), not just the parent table

### `inline_arrays` Controls Array VALUE Sorting

**Source:** `tomlsort.py` lines 386-387

```python
if self.sort_config(keys).inline_arrays:
    new_array_items = sorted(new_array_items, key=self.array_sort_func)
```

- `SortConfiguration.inline_arrays=True` (global) sorts ALL array values alphabetically
- `SortOverrideConfiguration.inline_arrays=True/False` overrides per-key path
- The merged config is computed by `sort_config(keys)` which overlays the override onto the global config

**Verified experimentally:** Setting global `inline_arrays=False` with per-path `inline_arrays=True` correctly sorts only the targeted arrays.

### `table_keys` Controls Key Ordering Within Tables

**Source:** `tomlsort.py` lines 529-533

```python
non_tables_final = (
    self.sort_keys(non_tables, sort_config)
    if sort_config.table_keys
    else non_tables
)
```

- `SortConfiguration.table_keys=True` (global) sorts keys alphabetically within all tables
- `SortOverrideConfiguration.table_keys=False` preserves key order within a specific table
- The override must match the TABLE's key path (e.g., `"tool.ruff"`)

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Selective array sorting | Custom post-processing to unsort arrays | toml-sort's `inline_arrays` override per key path | Built-in; tested; covers exact use case |
| Key order preservation | Manual key reordering after sort | toml-sort's `table_keys` override per table | Part of the API; works correctly |

**Key insight:** The entire fix is configuration changes in `config.py`. No new code logic is needed. toml-sort's existing override system supports all required behaviors.

## Common Pitfalls

### Pitfall 1: Override Key Path Must Match Full Path Including Intermediate Tables
**What goes wrong:** Override `tool.pytest.addopts` has no effect because the actual key path is `tool.pytest.ini_options.addopts`.
**Why it happens:** TOML section `[tool.pytest.ini_options]` adds `ini_options` to the key path. The override was written as if `addopts` were directly under `tool.pytest`.
**How to avoid:** Always trace the full TOML path: `[section.header]` + `key` = full path.
**Warning signs:** Debug logging shows `sort_array called: keys='tool.pytest.ini_options.addopts', inline_arrays=True` despite override existing.

### Pitfall 2: Global `inline_arrays=True` Sorts ALL Arrays
**What goes wrong:** Arrays that should preserve order (addopts, markers, keywords, omit, etc.) get alphabetically sorted.
**Why it happens:** The global setting applies to every array unless an override explicitly sets `inline_arrays=False`.
**How to avoid:** Use global `inline_arrays=False` and selectively enable for arrays that need sorting.
**Warning signs:** Arrays like `addopts = ["--dist", "--strict-config", ...]` are alphabetized, breaking positional argument semantics.

### Pitfall 3: `table_keys=False` Disables `first` List
**What goes wrong:** Setting global `table_keys=False` also disables the `first` list ordering, even if the override has a `first` list.
**Why it happens:** The `sorted_children_table` method only calls `sort_keys` (which applies the `first` list) when `table_keys=True`. With `table_keys=False`, keys stay in input order and `first` is ignored.
**How to avoid:** Use global `table_keys=False` but add `table_keys=True` override for tables that need `first`-list ordering (e.g., `project`, `build-system`).
**Verified experimentally:** Global `table_keys=False` + override `project` with `table_keys=True, first=[...]` correctly reorders project keys per the first list while preserving key order in all other tables.

### Pitfall 4: `sort_first` Order Must Match Golden File Exactly
**What goes wrong:** Tables appear in wrong order in output. Pipeline puts `project` before `build-system`, but golden has `build-system` first.
**Why it happens:** `sort_first` list has `project` at index 0 and `build-system` at index 2.
**How to avoid:** Compare `sort_first` list against the golden file's table order.
**Warning signs:** diff shows entire table blocks in different positions.

### Pitfall 5: Two Arrays Cannot Be Reproduced From Input
**What goes wrong:** `project.dependencies` and `tool.ruff.lint.per-file-ignores.**/tests/**` in the golden file have orderings that are neither the input order nor alphabetically sorted.
**Why it happens:** The user manually reordered these arrays in the golden file after the initial sort.
**How to avoid:** Accept that preserving input order is the closest achievable behavior. Update the golden file's `before.toml` input OR update the golden file's `after.toml` to match what the pipeline can actually produce from the given input.
**Impact:** These 2 arrays are the only ones where the golden file cannot be byte-for-byte reproduced. All other differences are fixable through configuration.

## Comprehensive Bug Catalog

### Bug Category 1: Table Ordering (sort_first)

**Pipeline order vs Golden file order for top-level tables:**

| Position | Pipeline | Golden | Fix |
|----------|----------|--------|-----|
| 1 | project | build-system | Swap in sort_first |
| 2 | build-system | project | Swap in sort_first |
| 4+ | tool.basedpyright | tool.git-cliff | Fix tool.* ordering |

**Required `sort_first` list to match golden:**
```python
first=[
    "build-system",
    "project",
    "project.*",
    "dependency-groups",
    "tool.git-cliff",
    "tool.pypis_delivery_service",
    "tool.ty",
    "tool.ty.*",
    "tool.uv",
    "tool.ruff",
    "tool.ruff.*",
    "tool.mypy",
    "tool.pyright",
    "tool.basedpyright",
    "tool.pylint",
    "tool.isort",
    "tool.black",
    "tool.pytest",
    "tool.pytest.*",
    "tool.coverage",
    "tool.coverage.*",
    "tool.semantic_release",
    "tool.semantic_release.*",
    "tool.hatch",
    "tool.hatch.*",
    "tool.*",
    "tool.tomlsort",
    "tool.tomlsort.*",
]
```

### Bug Category 2: Array Element Sorting

**Arrays the pipeline sorts but golden preserves (input order):**

| Array Key Path | Pipeline | Golden | Root Cause |
|---------------|----------|--------|------------|
| build-system.requires | Sorted | Preserved | Global inline_arrays=True |
| project.dynamic | Sorted | Preserved | Global inline_arrays=True |
| project.keywords | Sorted | Preserved | Global inline_arrays=True |
| project.dependencies | Sorted | Preserved* | Global inline_arrays=True |
| tool.pytest.ini_options.addopts | Sorted | Preserved | Override path mismatch |
| tool.pytest.ini_options.markers | Sorted | Preserved | No override exists |
| tool.pytest.ini_options.pythonpath | Sorted | Preserved | No override exists |
| tool.pytest.ini_options.testpaths | Sorted | Preserved | No override exists |
| tool.coverage.run.omit | Sorted | Preserved | No override exists |
| tool.coverage.run.source | Sorted | Preserved | No override exists |
| tool.coverage.report.exclude_lines | Sorted | Preserved | No override exists |
| tool.ruff.src | Sorted | Preserved | Override tool.ruff.* sorts, should preserve |
| tool.ruff.lint.per-file-ignores.**/tests/** | Sorted | Preserved* | Override tool.ruff.* sorts |
| tool.ruff.lint.per-file-ignores.typings/** | Sorted | Preserved | Override tool.ruff.* sorts |
| tool.ruff.lint.per-file-ignores.**/scripts/** | Sorted | Preserved | Override tool.ruff.* sorts |
| tool.ruff.lint.per-file-ignores.claude_lint_hook.py | Sorted | Preserved | Override tool.ruff.* sorts |
| tool.semantic_release.commit_parser_options.patch_tags | Sorted | Preserved | Override sorts |
| tool.semantic_release.commit_parser_options.allowed_tags | Sorted | Preserved | Override sorts |
| tool.semantic_release.commit_parser_options.minor_tags | Sorted | Preserved | Override sorts |
| tool.hatch.build.targets.sdist.include | Sorted | Preserved | No override exists |

*`project.dependencies` and `tool.ruff.lint.per-file-ignores.**/tests/**` have golden orderings that are manually edited (neither input order nor alphabetical). Preserving input order is the closest achievable fix.

**Arrays correctly sorted by both pipeline and golden:**

| Array Key Path | Sorting |
|---------------|---------|
| project.classifiers | Alphabetical |
| tool.ruff.lint.extend-select | Alphabetical |
| tool.ruff.lint.ignore | Alphabetical |

### Bug Category 3: Key Ordering Within Tables

The pipeline sorts keys alphabetically within tables (global `table_keys=True`). The golden file preserves original key ordering for most tables.

**Tables where pipeline sorts keys but golden preserves order:**

| Table | Pipeline | Golden |
|-------|----------|--------|
| tool.ruff | Keys sorted (fix, line-length, src...) | Keys preserved (src, line-length, target-version...) |
| tool.semantic_release | Keys sorted | Keys preserved |
| tool.pytest.ini_options | Keys sorted | Keys preserved |

**Fix:** Set global `table_keys=False`. Add `table_keys=True` override for `project` and `build-system` (which need `first` list ordering). All other tables preserve input key order.

**CRITICAL:** `table_keys=False` disables the `first` list. Tables that need `first`-list ordering MUST have `table_keys=True` on their override. Verified experimentally: global `table_keys=False` + override `project` with `table_keys=True, first=[...]` correctly reorders project keys per the first list while preserving key order in all other tables.

### Bug Category 4: Formatting (taplo)

**No bugs.** taplo is idempotent on the golden file. The comment alignment (`align_comments=true`) produces output matching the golden file. The only formatting differences in the full pipeline diff come from taplo normalizing the toml-sort output, which is correct behavior.

Specific taplo behaviors confirmed correct:
- Inline table spacing: `{name = "Jamie"}` -> `{ name = "Jamie" }` (matches golden)
- Comment alignment: `"A",  # comment` -> `"A",     # comment` (matches golden)
- No key reordering (taplo has `reorder_keys=false`)

## Code Examples

### Fix 1: Correct sort_first order

```python
# Source: Analysis of golden file table ordering
def get_sort_config() -> SortConfiguration:
    return SortConfiguration(
        tables=True,
        table_keys=True,  # or False globally -- see analysis
        inline_tables=False,
        inline_arrays=False,  # CHANGED from True
        ignore_case=False,
        first=[
            "build-system",       # MOVED: was at index 2
            "project",            # MOVED: was at index 0
            "project.*",
            "dependency-groups",
            "tool.git-cliff",
            "tool.pypis_delivery_service",
            "tool.ty",
            "tool.ty.*",          # ADDED: needed for sub-table ordering
            "tool.uv",
            "tool.ruff",          # MOVED: was after tool.ty
            "tool.ruff.*",        # ADDED
            "tool.mypy",
            "tool.pyright",
            "tool.basedpyright",
            "tool.pylint",
            "tool.isort",
            "tool.black",
            "tool.pytest",        # MOVED: was before tool.coverage
            "tool.pytest.*",      # ADDED
            "tool.coverage",
            "tool.coverage.*",    # ADDED
            "tool.semantic_release",
            "tool.semantic_release.*",  # ADDED
            "tool.hatch",         # MOVED: was near the top
            "tool.hatch.*",       # ADDED
            "tool.*",
            "tool.tomlsort",
            "tool.tomlsort.*",    # ADDED (already existed as override)
        ],
    )
```

### Fix 2: Selective array sorting via overrides

```python
# Source: toml-sort API verification
def get_sort_overrides() -> dict[str, SortOverrideConfiguration]:
    return {
        # Arrays that SHOULD be sorted alphabetically
        "project.classifiers": SortOverrideConfiguration(inline_arrays=True),
        "tool.ruff.lint.extend-select": SortOverrideConfiguration(inline_arrays=True),
        "tool.ruff.lint.ignore": SortOverrideConfiguration(inline_arrays=True),
        "dependency-groups.*": SortOverrideConfiguration(inline_arrays=True),
        # ... all other existing overrides with corrected paths
    }
```

### Fix 3: Correct override key paths

```python
# WRONG: "tool.pytest.addopts"     -- matches nothing
# RIGHT: "tool.pytest.ini_options"  -- matches the table
# RIGHT: "tool.pytest.ini_options.*" -- matches arrays within
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Global `inline_arrays=True` | Selective per-path overrides | This phase | Preserves array order except where sorting is wanted |
| Override `tool.pytest.addopts` | Override `tool.pytest.ini_options.*` | This phase | Actually matches the key path |

## Open Questions

1. **project.dependencies ordering**
   - What we know: Golden file has order `[gitpython, mypy, basedpyright, ruff, typer]`. Input has `[basedpyright, ruff, typer, gitpython, mypy]`. Neither is alphabetical.
   - What's unclear: Whether the user intentionally reordered this in the golden file.
   - Recommendation: Ask user. Options: (a) update `before.toml` to match golden ordering, (b) update golden `after.toml` to accept preserved input order, (c) update golden `after.toml` to accept alphabetical sort.

2. **tool.ruff.lint.per-file-ignores.\*\*/tests/\*\* ordering**
   - What we know: Golden file has order `[S, D, E501, ANN, ...]`. Input has `[ANN, DOC, PLC, ...]`. Neither is alphabetical.
   - What's unclear: Whether the user intentionally reordered this.
   - Recommendation: Same options as above.

3. **Global table_keys setting** (RESOLVED)
   - What we know: Golden file preserves key order in most tables. Only `project` and `build-system` use `first` lists.
   - Finding: `table_keys=False` disables the `first` list. The `first` list only works when `table_keys=True`.
   - Resolution: Set global `table_keys=False`, add `table_keys=True` override for `project` and `build-system` (which need `first` list ordering). Verified experimentally.

## Sources

### Primary (HIGH confidence)
- **toml-sort source code**: `/home/ubuntulinuxqa2/repos/pyproject-fmt/.venv/lib/python3.14/site-packages/toml_sort/tomlsort.py` -- read in full, all claims verified against source
- **Golden file (specification)**: `git show c7e8f30:tests/fixtures/after.toml` -- restored and diffed
- **Pipeline output**: Generated by running `format_pyproject()` on `before.toml` -- diffed against golden
- **Experimental verification**: `inline_arrays` override behavior tested with isolated TOML inputs
- **Debug logging**: Monkey-patched `sort_array` to log key paths and config values during actual pipeline run

### Secondary (MEDIUM confidence)
- **Incident report**: `/home/ubuntulinuxqa2/repos/pyproject-fmt/.planning/INCIDENT-001-golden-file-contamination.md`

## Metadata

**Confidence breakdown:**
- Bug catalog: HIGH -- every difference identified by byte-level diff between pipeline output and golden file
- Fix approach: HIGH -- toml-sort API behavior verified experimentally with isolated test cases
- sort_first order: MEDIUM -- derived from golden file analysis; some sub-table ordering may need adjustment
- Open questions: HIGH confidence that these are genuine ambiguities requiring user input

**Research date:** 2026-02-14
**Valid until:** Until phase 3.1 is implemented (no external dependency changes expected)
