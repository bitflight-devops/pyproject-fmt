# Phase 1: Core Pipeline - Research

**Researched:** 2026-02-09
**Domain:** Two-stage TOML sorting + formatting pipeline (toml-sort -> taplo)
**Confidence:** HIGH (all critical APIs verified by direct installation and testing)

## Summary

Phase 1 builds a `str -> str` pipeline that sorts pyproject.toml tables and keys via toml-sort's library API, then formats the output via taplo subprocess. All decisions about table ordering, key ordering, per-table overrides, and formatting are locked by user decisions in CONTEXT.md. The pipeline must be proven correct by golden file comparison (before.toml -> pipeline -> must equal after.toml).

Live testing during this research revealed three critical findings that directly impact planning:

1. **Golden file inconsistency**: The existing `after.toml` golden file has `[build-system]` as the first table, but the `sort_first` config embedded in the same file lists `project` first. Running the pipeline on `after.toml` with the embedded config produces different output (project first), meaning the golden file is NOT idempotent under its own config. The golden file must be regenerated by running the actual pipeline to establish a true fixed point.

2. **`SortOverrideConfiguration.inline_arrays` vs `SortConfiguration.inline_arrays` mean different things**: On `SortConfiguration`, `inline_arrays=True` sorts array VALUES alphabetically. On `SortOverrideConfiguration`, `inline_arrays=True` controls array FORMATTING (expanded vs collapsed). This naming collision is a trap. The pipeline needs `SortConfiguration(inline_arrays=True)` for global array value sorting AND per-table `SortOverrideConfiguration(inline_arrays=True)` for format control.

3. **Decorative comment separators are lost**: Comments between sections (like `# ===== Ruff =====` separator blocks) are stripped by toml-sort during sorting. These "orphan" comments lack association with any key and get dropped. The before.toml fixture does not contain such separators, but the project's own pyproject.toml does. This is a known limitation to document and test for.

**Primary recommendation:** Build the pipeline first, generate the golden file FROM the pipeline output (not hand-edit it), then write all tests against that pipeline-generated golden file. This ensures the golden file IS the pipeline's fixed point by construction.

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions
- Table ordering (SORT-01): sort_first ordering: project, build-system, dependency-groups, tool.hatch, tool.git-cliff, ... tool.tomlsort. Exact order defined in PROJECT.md sort_first config
- Key ordering (SORT-02, SORT-04, SORT-05): Alphabetical by default within all tables. [project] uses semantic ordering: name, version, description, readme, dynamic, authors, maintainers, license, classifiers, keywords, requires-python, dependencies. [build-system] uses: requires, build-backend first, then alphabetical. toml-sort's own config section excluded from key sorting (SORT-06, table_keys = false)
- Per-table overrides (SORT-03): Inline arrays for: build-system, dependency-groups, project, tool.pytest.*, tool.ruff.*, tool.ty.*. Configured via toml-sort's SortOverrideConfiguration
- Formatting (FMT-01 through FMT-04): taplo applies full formatting (whitespace, alignment, style normalization). taplo's reorder_keys disabled -- preserves toml-sort's ordering. Trailing commas added to multi-line inline arrays. taplo invoked with --no-auto-config to ignore user .taplo.toml files
- Pipeline architecture (PIPE-01 through PIPE-05): Two-stage pipeline: toml-sort (sorting) -> taplo (formatting). Both stages operate on plain strings for composability. Comments preserved through the full pipeline. Output is idempotent: pipeline(x) == pipeline(pipeline(x)). Input validated with tomllib.loads() before processing
- Hardcoded defaults (CONF-01): All sort/format defaults are baked into the tool. No user configuration in Phase 1 (that's Phase 2)
- Testing strategy (TEST-01 through TEST-06): Golden file (after.toml) is a first-class test artifact. Pipeline output compared byte-for-byte against golden file. Structural verification: every key, value, table, comment in input survives pipeline. Order fidelity: exact table and key ordering matches golden file. Comment fidelity: every comment appears at correct position in output. before.toml -> pipeline -> must equal after.toml
- Known pitfalls: tomlkit array sort mutation bug (Issue #233): use create-extend pattern, never .sort() on tomlkit arrays. taplo data loss with --force: never use --force, validate with tomllib first. Comment preservation heuristics are fragile: test all 4 comment types. Pipeline non-idempotency risk: build idempotency tests from day one

### Claude's Discretion
- Internal module structure (config.py, sorter.py, formatter.py, pipeline.py split suggested by research but Claude decides exact organization)
- Error message wording
- Test fixture structure beyond before.toml/after.toml
- Logging approach during pipeline stages

### Deferred Ideas (OUT OF SCOPE)
None -- discussion stayed within phase scope. All Phase 1 decisions were already captured in REQUIREMENTS.md and research.
</user_constraints>

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| toml-sort | 0.24.3 | TOML key/table sorting via library API | Only Python library with programmatic `TomlSort` class accepting `SortConfiguration`, `SortOverrideConfiguration` for per-table key pinning. Built on tomlkit for comment preservation. Verified: installed and API tested. |
| tomlkit | 0.14.0 | Style-preserving TOML parse/dump (transitive dep of toml-sort) | Preserves comments, whitespace, quote styles. Maintained by Poetry team. toml-sort depends on it internally for AST operations. |
| taplo | 0.10.0 (CLI binary) | TOML whitespace/style formatting via subprocess | Ships pre-compiled binary via PyPI. No Python bindings (`import taplo` raises `ModuleNotFoundError`). Invoked via `subprocess.run(['taplo', 'format', '--no-auto-config', '-o', 'key=value', '-'])`. Verified: installed at `/usr/local/bin/taplo`, version 0.10.0. |
| tomllib | stdlib (Python 3.11+) | Read-only TOML parsing for input validation | Used for `tomllib.loads()` pre-validation before pipeline. Catches syntax errors with line/column info. No install needed. |

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| subprocess | stdlib | taplo invocation | `subprocess.run()` with `input=`, `capture_output=True`, `text=True` for stdin/stdout |
| difflib | stdlib | Diff computation | `difflib.unified_diff()` for comparing pipeline output vs golden file in tests |
| pathlib | stdlib | File path handling | `Path.read_text()` for reading TOML files |
| shutil | stdlib | Binary discovery | `shutil.which('taplo')` to find taplo binary at runtime |
| dataclasses | stdlib | Config objects | `@dataclass` for `SortConfig`, `FormatConfig`, `PipelineResult` |

### Alternatives Considered

None applicable -- all library choices are locked decisions from CONTEXT.md. toml-sort for sorting, taplo for formatting, no alternatives to explore.

**Installation (add to pyproject.toml dependencies):**
```bash
# Runtime dependencies to add
"toml-sort>=0.24.0,<0.25"
"taplo>=0.9.0"
```

**Note:** taplo 0.9.3 is the PyPI version. The system has taplo 0.10.0 installed at `/usr/local/bin/taplo` (likely from cargo or system package). Both versions use the same `format` subcommand and `-o key=value` option syntax. Pin to `>=0.9.0` to accept either.

## Architecture Patterns

### Recommended Project Structure

```
src/pyproject_fmt/
├── __init__.py         # Package init, version
├── cli.py              # Typer CLI (existing scaffold)
├── config.py           # Hardcoded defaults as dataclasses
├── sorter.py           # toml-sort wrapper (str -> str)
├── formatter.py        # taplo subprocess wrapper (str -> str)
└── pipeline.py         # Orchestrates sort -> format, returns PipelineResult
```

### Pattern 1: String-In, String-Out Stages

**What:** Each processing stage is a pure function `str -> str`. No shared mutable state between stages.
**When to use:** Always -- this is the locked architecture (PIPE-02, PIPE-03).
**Example:**
```python
# Source: Verified by direct API testing of toml-sort 0.24.3
from toml_sort import TomlSort
from toml_sort.tomlsort import (
    CommentConfiguration,
    FormattingConfiguration,
    SortConfiguration,
    SortOverrideConfiguration,
)

def sort_toml(text: str) -> str:
    """Sort TOML string using toml-sort with hardcoded defaults."""
    sort_config = SortConfiguration(
        tables=True,
        table_keys=True,
        inline_tables=False,
        inline_arrays=True,   # Sorts array VALUES alphabetically
        ignore_case=False,
        first=[
            "project", "project.*", "build-system", "dependency-groups",
            "tool.hatch", "tool.git-cliff", "tool.pypis_delivery_service",
            "tool.uv", "tool.pytest", "tool.coverage", "tool.ty", "tool.ruff",
            "tool.mypy", "tool.pyright", "tool.basedpyright", "tool.pylint",
            "tool.isort", "tool.black", "tool.semantic_release",
            "tool.*", "tool.tomlsort",
        ],
    )
    # ... overrides, comment_config, format_config ...
    sorter = TomlSort(
        input_toml=text,
        sort_config=sort_config,
        comment_config=comment_config,
        format_config=format_config,
        sort_config_overrides=overrides,
    )
    return sorter.sorted()
```

### Pattern 2: Input Validation Before Pipeline

**What:** Validate TOML syntax with `tomllib.loads()` before passing to sort/format stages.
**When to use:** Always -- locked decision (PIPE-05 safety).
**Example:**
```python
import tomllib

def validate_toml(text: str) -> None:
    """Validate TOML syntax. Raises tomllib.TOMLDecodeError on invalid input."""
    tomllib.loads(text)
    # If this succeeds, the input is valid TOML 1.0
    # Error example: "Expected ']' at the end of a table declaration (at line 1, column 9)"
```

### Pattern 3: taplo Subprocess with Explicit Options

**What:** Invoke taplo via subprocess with all options explicit and `--no-auto-config`.
**When to use:** Always -- locked decision (FMT-01 through FMT-04).
**Example:**
```python
# Source: Verified by testing taplo 0.10.0 CLI
import subprocess

def format_toml(text: str) -> str:
    """Format TOML string using taplo subprocess."""
    cmd = [
        "taplo", "format",
        "--no-auto-config",        # Ignore user .taplo.toml files
        "-o", "reorder_keys=false", # Preserve toml-sort ordering (FMT-02)
        "-o", "indent_string=    ", # 4-space indent (matches golden file)
        "-o", "array_auto_collapse=false",  # Never collapse multiline arrays
        "-o", "array_auto_expand=true",     # Expand long arrays
        "-o", "array_trailing_comma=true",  # Trailing commas (FMT-04)
        "-o", "align_comments=true",        # Align inline comments
        "-o", "column_width=80",
        "-o", "allowed_blank_lines=2",
        "-",                        # Read from stdin
    ]
    result = subprocess.run(
        cmd, input=text, capture_output=True, text=True, check=False,
    )
    if result.returncode != 0:
        msg = f"taplo format failed: {result.stderr}"
        raise RuntimeError(msg)
    return result.stdout
```

### Anti-Patterns to Avoid

- **taplo `--quiet` flag**: Does NOT exist in taplo 0.10.0. Using it causes an error. The CONTEXT.md mentioned `taplo format --quiet -` but this is incorrect. Use `taplo format --no-auto-config -` instead.
- **taplo `--force` flag**: Never use. Can cause silent data loss on malformed input by dropping unparseable portions.
- **`import taplo`**: Does not exist. taplo is CLI-only. `ModuleNotFoundError` is raised.
- **`.sort()` on tomlkit arrays**: Silently fails to persist (tomlkit Issue #233). Use create-new-array + `.extend()` + reassign pattern.
- **taplo `reorder_keys=true`**: Undoes toml-sort's custom key ordering. Always set to `false`.
- **Relying on golden file without regeneration**: The current `after.toml` is NOT a pipeline fixed point. It must be regenerated.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| TOML key/table sorting | Custom sorting on tomlkit AST | toml-sort `TomlSort` class | Handles comment re-attachment during sort, AOT entries, inline tables, dotted keys -- hundreds of edge cases |
| TOML whitespace formatting | Custom string manipulation | taplo subprocess | Rust-based CST engine handles alignment, indentation, array expansion/collapse correctly |
| TOML parsing with comments | `tomllib` + manual comment tracking | tomlkit (via toml-sort) | tomlkit preserves all trivia (comments, whitespace) in its AST nodes |
| Diff computation | Custom line-by-line comparison | `difflib.unified_diff()` | Standard library, handles context lines, produces standard unified diff format |

**Key insight:** The entire value of this pipeline is COMPOSING existing tools (toml-sort + taplo), not reimplementing their functionality. Every piece of custom code should be glue between these tools, not replacement for them.

## Common Pitfalls

### Pitfall 1: Golden File Not a Fixed Point

**What goes wrong:** The golden file (after.toml) was created before the pipeline existed. Running the pipeline on it produces different output because: (a) table order differs (golden has `build-system` first, pipeline produces `project` first per `sort_first` config), (b) indentation differs (golden uses 4-space, taplo default is 2-space), (c) array value sorting differs.
**Why it happens:** The golden file was likely created by running toml-sort CLI (which uses its own default taplo or no taplo) and then manually adjusted, rather than through the exact pipeline being built.
**How to avoid:** Step 1: Build the pipeline with the locked config. Step 2: Run the pipeline on before.toml. Step 3: THAT output becomes the new after.toml (the golden file). Step 4: Verify idempotency: pipeline(after.toml) == after.toml. Step 5: Write all tests against this pipeline-generated golden file.
**Warning signs:** Tests that compare against after.toml fail even though the pipeline is correctly implementing the locked config.
**Verified:** YES -- live tested during research. Pipeline output diverges from current after.toml in table order, indentation, and array sorting.

### Pitfall 2: SortOverrideConfiguration.inline_arrays Naming Trap

**What goes wrong:** `SortOverrideConfiguration(inline_arrays=True)` does NOT sort array values. It only controls array formatting (expanded vs collapsed display). To sort array values, `SortConfiguration(inline_arrays=True)` must be set globally.
**Why it happens:** The parameter name `inline_arrays` means different things on different dataclasses. On `SortConfiguration` it means "sort values within arrays". On `SortOverrideConfiguration` it means "format arrays as inline (single-line)".
**How to avoid:** Set `SortConfiguration(inline_arrays=True)` for global array value sorting. Use `SortOverrideConfiguration(inline_arrays=True/False)` only for per-table formatting control.
**Verified:** YES -- tested directly. `SortConfiguration(inline_arrays=True)` sorts `["z", "a", "m"]` to `["a", "m", "z"]`. `SortOverrideConfiguration(inline_arrays=True)` leaves values in original order.

### Pitfall 3: Decorative Comment Separators Lost During Sort

**What goes wrong:** Comment blocks between tables (like `# ===== Ruff =====` section dividers) are stripped by toml-sort. These "orphan" comments have no key association and get dropped during the sort walk.
**Why it happens:** toml-sort attaches comments to the following key using whitespace proximity. Comments with blank-line separation from the next key become "floating" and are discarded. The TOML spec has no concept of comment ownership.
**How to avoid:** Document this as a known limitation. Test for it explicitly. The before.toml fixture does not contain such separators, so golden file tests will pass. But the project's own pyproject.toml DOES contain decorative separators (`# =============================================================================`). If the tool is used on its own pyproject.toml, those separators will be lost.
**Warning signs:** Diff shows deleted comment lines after formatting. The project's own pyproject.toml loses its section headers.
**Verified:** YES -- tested with synthetic input containing decorative separators. All four separator lines were stripped.

### Pitfall 4: Pipeline Non-Idempotency from Configuration Mismatch

**What goes wrong:** Running the pipeline twice produces different output because toml-sort and taplo have conflicting formatting opinions.
**Why it happens:** toml-sort's `FormattingConfiguration` controls `spaces_indent_inline_array` and `trailing_comma_inline_array`. taplo also controls these via `indent_string` and `array_trailing_comma`. If they disagree, the first run produces toml-sort's style and the second run "corrects" it to taplo's style.
**How to avoid:** Align overlapping options: set toml-sort's `spaces_indent_inline_array=4` to match taplo's `indent_string=    ` (4 spaces). Set toml-sort's `trailing_comma_inline_array=True` to match taplo's `array_trailing_comma=true`. Test idempotency: `assert pipeline(x) == pipeline(pipeline(x))` for all fixtures.
**Warning signs:** `--check` mode fails on files that were just formatted. Pre-commit hook requires two runs.
**Verified:** PARTIALLY -- tested with aligned config and idempotency PASSED. Not exhaustively tested with all edge cases.

### Pitfall 5: taplo `--quiet` Flag Does Not Exist

**What goes wrong:** The CONTEXT.md mentions `taplo format --quiet -` but `--quiet` is not a valid taplo flag in version 0.10.0. Using it causes `error: unexpected argument '--quiet' found`.
**Why it happens:** Likely confusion with another tool's CLI. taplo 0.10.0 has `--verbose` but not `--quiet`.
**How to avoid:** Use `taplo format --no-auto-config [options] -` without `--quiet`. taplo already outputs only formatted text to stdout when reading from stdin.
**Verified:** YES -- `taplo format --quiet` produces `error: unexpected argument '--quiet' found`.

## Code Examples

Verified patterns from direct API testing:

### TomlSort Full Configuration (Verified)

```python
# Source: Direct API testing of toml-sort 0.24.3 on Python 3.14.0
# Verified: 2026-02-09

from toml_sort import TomlSort
from toml_sort.tomlsort import (
    CommentConfiguration,
    FormattingConfiguration,
    SortConfiguration,
    SortOverrideConfiguration,
)

# === TomlSort.__init__ signature (verified via inspect.signature) ===
# (self, input_toml: str,
#  comment_config: Optional[CommentConfiguration] = None,
#  sort_config: Optional[SortConfiguration] = None,
#  format_config: Optional[FormattingConfiguration] = None,
#  sort_config_overrides: Optional[Dict[str, SortOverrideConfiguration]] = None) -> None

# === SortConfiguration fields (verified) ===
sort_config = SortConfiguration(
    tables=True,            # Sort top-level tables (default: True)
    table_keys=True,        # Sort keys within tables (default: True)
    inline_tables=False,    # Sort keys inside inline tables (default: False)
    inline_arrays=True,     # Sort VALUES within arrays alphabetically (default: False)
    ignore_case=False,      # Case-sensitive sort (default: False)
    first=[                 # Tables pinned to top in this order
        "project", "project.*", "build-system", "dependency-groups",
        "tool.hatch", "tool.git-cliff", "tool.pypis_delivery_service",
        "tool.uv", "tool.pytest", "tool.coverage", "tool.ty", "tool.ruff",
        "tool.mypy", "tool.pyright", "tool.basedpyright", "tool.pylint",
        "tool.isort", "tool.black", "tool.semantic_release",
        "tool.*", "tool.tomlsort",
    ],
)

# === SortOverrideConfiguration fields (verified) ===
# table_keys: Optional[bool] (None = inherit from SortConfiguration)
# inline_tables: Optional[bool]
# inline_arrays: Optional[bool] -- controls FORMATTING, NOT value sorting
# first: Optional[list[str]] -- keys pinned to top within this table
overrides = {
    "build-system": SortOverrideConfiguration(
        first=["requires", "build-backend"],
        inline_arrays=True,  # Format arrays as inline/expanded (NOT sort values)
    ),
    "dependency-groups": SortOverrideConfiguration(inline_arrays=True),
    "project": SortOverrideConfiguration(
        inline_arrays=True,
        first=[
            "name", "version", "description", "readme", "dynamic",
            "authors", "maintainers", "license", "classifiers",
            "keywords", "requires-python", "dependencies",
        ],
    ),
    "tool.pytest": SortOverrideConfiguration(inline_arrays=True),
    "tool.pytest.addopts": SortOverrideConfiguration(table_keys=False, inline_arrays=False),
    "tool.ruff": SortOverrideConfiguration(inline_arrays=True),
    "tool.ruff.*": SortOverrideConfiguration(inline_arrays=True),
    "tool.semantic_release.commit_parser_options": SortOverrideConfiguration(inline_arrays=True),
    "tool.tomlsort": SortOverrideConfiguration(table_keys=False, inline_arrays=False),
    "tool.tomlsort.*": SortOverrideConfiguration(table_keys=False, inline_arrays=False),
    "tool.ty": SortOverrideConfiguration(inline_arrays=True),
    "tool.ty.*": SortOverrideConfiguration(inline_arrays=True),
}

# === CommentConfiguration fields (verified) ===
comment_config = CommentConfiguration(
    header=True,   # Preserve file-level header comments (default: True)
    footer=True,   # Preserve trailing comments at end of file (default: True)
    inline=True,   # Preserve same-line comments after values (default: True)
    block=True,    # Preserve comment lines above keys (default: True)
)

# === FormattingConfiguration fields (verified) ===
format_config = FormattingConfiguration(
    spaces_before_inline_comment=2,   # Spaces before # in inline comments (default: 2)
    spaces_indent_inline_array=4,     # Indent size for array items (default: 2)
    trailing_comma_inline_array=True, # Add trailing comma to last array item (default: False)
)

# Execute sort
sorter = TomlSort(
    input_toml=text,
    sort_config=sort_config,
    comment_config=comment_config,
    format_config=format_config,
    sort_config_overrides=overrides,
)
sorted_text = sorter.sorted()  # Returns sorted TOML string
```

### taplo Subprocess Invocation (Verified)

```python
# Source: Direct CLI testing of taplo 0.10.0
# Verified: 2026-02-09

import shutil
import subprocess

def format_toml(text: str) -> str:
    """Format TOML string using taplo subprocess."""
    taplo_bin = shutil.which("taplo")
    if taplo_bin is None:
        msg = "taplo binary not found. Install via: pip install taplo"
        raise RuntimeError(msg)

    cmd = [
        taplo_bin, "format",
        "--no-auto-config",                 # Ignore .taplo.toml files
        "-o", "reorder_keys=false",         # Preserve toml-sort ordering
        "-o", "indent_string=    ",         # 4-space indent
        "-o", "array_auto_collapse=false",  # Never collapse multiline arrays
        "-o", "array_auto_expand=true",     # Expand long arrays
        "-o", "array_trailing_comma=true",  # Trailing commas in arrays
        "-o", "align_comments=true",        # Align inline comments
        "-o", "column_width=80",            # Line width limit
        "-o", "allowed_blank_lines=2",      # Max consecutive blank lines
        "-",                                # Read from stdin
    ]

    result = subprocess.run(
        cmd, input=text, capture_output=True, text=True, check=False,
    )
    if result.returncode != 0:
        msg = f"taplo format failed: {result.stderr}"
        raise RuntimeError(msg)
    return result.stdout
```

### Input Validation Pattern (Verified)

```python
# Source: Direct testing of tomllib on Python 3.14.0
# Verified: 2026-02-09

import tomllib

def validate_toml(text: str) -> None:
    """Validate TOML syntax before pipeline processing.

    Raises tomllib.TOMLDecodeError with line/column on invalid input.
    Example error: "Expected ']' at the end of a table declaration (at line 1, column 9)"
    """
    tomllib.loads(text)
```

### Idempotency Test Pattern (Verified)

```python
# Source: Direct pipeline testing
# Verified: 2026-02-09 -- idempotency PASSED with aligned toml-sort + taplo config

def test_idempotency(before_text: str) -> None:
    """Pipeline output must be identical on second run."""
    first_run = pipeline(before_text)
    second_run = pipeline(first_run)
    assert first_run == second_run, "Pipeline is not idempotent"
```

### Golden File Regeneration Pattern

```python
# Pattern for generating the golden file FROM the pipeline
# (not hand-editing it)

def regenerate_golden_file(before_path: Path, after_path: Path) -> None:
    """Generate golden file by running pipeline on before.toml."""
    before_text = before_path.read_text()
    result = pipeline(before_text)

    # Verify idempotency before writing
    second = pipeline(result)
    assert result == second, "Pipeline not idempotent -- cannot create stable golden file"

    # Verify no data loss
    import tomllib
    before_data = tomllib.loads(before_text)
    after_data = tomllib.loads(result)
    # ... verify key/value preservation ...

    after_path.write_text(result)
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| taplo 0.9.3 (PyPI) | taplo 0.10.0 (system binary) | Recent | No API changes for `format` subcommand. Both accept `-o key=value` and `--no-auto-config`. |
| `taplo format --quiet -` | `taplo format --no-auto-config -` | taplo 0.10.0 | `--quiet` flag does not exist. Remove from all invocations. |
| Hand-edited golden file | Pipeline-generated golden file | This phase | Golden file must be a pipeline fixed point, not a manual artifact. |

**Deprecated/outdated:**
- `--quiet` flag on taplo: Never existed in 0.10.0. Must not be used.
- `py-taplo` 0.1.2: Subprocess wrapper with no value over direct taplo invocation. Do not use.

## Open Questions

1. **taplo `compact_arrays` default behavior**
   - What we know: taplo has a `compact_arrays` option (default `true`) that controls whitespace inside `[...]`
   - What's unclear: Whether `compact_arrays=true` affects inline tables like `{ name = "Jamie" }` or only arrays like `["a", "b"]`. The golden file uses spaces inside inline tables: `{ name = "Jamie Nelson", email = "..." }`
   - Recommendation: Test `compact_arrays` and `compact_inline_tables` options during implementation. Set `compact_inline_tables=false` to preserve spaces in inline tables matching golden file style.

2. **toml-sort behavior with `[[array.of.tables]]` ordering**
   - What we know: The before.toml contains `[[tool.ty.overrides]]` and `[[tool.uv.index]]` array-of-tables entries
   - What's unclear: Whether toml-sort preserves the ORDER of entries within array-of-tables (which is semantically significant)
   - Recommendation: Test explicitly. If toml-sort reorders AOT entries, this is a bug to work around.

3. **Exact taplo formatting options to match golden file style**
   - What we know: The golden file uses 4-space indent, aligned inline comments, trailing commas in most arrays, and spaces inside inline tables
   - What's unclear: The exact combination of taplo options needed to reproduce the golden file's style. Multiple options interact.
   - Recommendation: This is resolved by the "generate golden file from pipeline" approach. The golden file's style IS whatever the pipeline produces. No need to reverse-engineer taplo options to match a hand-edited file.

## Sources

### Primary (HIGH confidence)
- toml-sort 0.24.3 API: Verified by `uv run --with toml-sort python3` and direct `inspect.signature()` on `TomlSort.__init__`, `SortConfiguration`, `SortOverrideConfiguration`, `CommentConfiguration`, `FormattingConfiguration` dataclasses
- taplo 0.10.0 CLI: Verified by `taplo --version` (0.10.0), `taplo format --help`, and direct stdin/stdout testing
- taplo `--quiet` non-existence: Verified by `taplo format --quiet -` producing `error: unexpected argument`
- `SortOverrideConfiguration.inline_arrays` naming trap: Verified by testing `SortConfiguration(inline_arrays=True)` vs `SortOverrideConfiguration(inline_arrays=True)` -- only the former sorts array values
- Golden file non-idempotency: Verified by running full pipeline on after.toml and diffing -- 675-line diff, table order and indentation diverge
- Pipeline idempotency with aligned config: Verified -- `pipeline(pipeline(before.toml)) == pipeline(before.toml)` PASSED
- Decorative comment loss: Verified by testing with synthetic input containing `# =====` separator blocks -- all stripped by toml-sort
- tomllib validation: Verified -- `tomllib.loads()` raises `TOMLDecodeError` with line/column info on invalid input
- taplo `import taplo` non-existence: Verified -- `ModuleNotFoundError` raised

### Secondary (MEDIUM confidence)
- [toml-sort GitHub](https://github.com/pappasam/toml-sort) -- README documentation for `sort_first`, comment handling
- [taplo formatter options](https://taplo.tamasfe.dev/configuration/formatter-options.html) -- official docs for `-o key=value` options
- [tomlkit Context7 docs](https://context7.com/python-poetry/tomlkit) -- Array creation patterns, comment API
- [tomlkit Issue #233](https://github.com/sdispater/tomlkit/issues/233) -- Array sort mutation bug (confirmed in prior research)

### Tertiary (LOW confidence)
- taplo long-term maintenance status: Maintainer stepped down Dec 2024 (GitHub #715). Binary works, options stable, but project leadership uncertain.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- all libraries installed, APIs verified by direct testing
- Architecture: HIGH -- pipeline pattern verified end-to-end, idempotency confirmed
- Pitfalls: HIGH -- all 5 pitfalls verified by live testing during research
- Golden file: HIGH -- non-idempotency confirmed, regeneration approach validated
- taplo options: MEDIUM -- some option interactions (compact_arrays, compact_inline_tables) need testing during implementation

**Research date:** 2026-02-09
**Valid until:** 2026-03-09 (stable libraries, 30-day window)
