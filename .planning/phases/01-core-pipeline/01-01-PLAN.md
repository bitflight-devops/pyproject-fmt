---
phase: 01-core-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pyproject_fmt/config.py
  - src/pyproject_fmt/sorter.py
  - src/pyproject_fmt/formatter.py
  - src/pyproject_fmt/pipeline.py
  - pyproject.toml
  - tests/fixtures/after.toml
autonomous: true

must_haves:
  truths:
    - "Pipeline accepts a TOML string and returns a sorted, formatted TOML string"
    - "Running pipeline twice on the same input produces identical output (idempotency)"
    - "Invalid TOML input raises a clear error before any processing"
    - "All hardcoded defaults match the locked decisions from CONTEXT.md exactly"
    - "Golden file (after.toml) is a pipeline fixed point -- pipeline(after.toml) == after.toml byte-for-byte"
  artifacts:
    - path: "src/pyproject_fmt/config.py"
      provides: "Hardcoded sort/format configuration as dataclasses"
      contains: "SortConfiguration"
    - path: "src/pyproject_fmt/sorter.py"
      provides: "toml-sort wrapper (str -> str)"
      contains: "def sort_toml"
    - path: "src/pyproject_fmt/formatter.py"
      provides: "taplo subprocess wrapper (str -> str)"
      contains: "def format_toml"
    - path: "src/pyproject_fmt/pipeline.py"
      provides: "Pipeline orchestrator: validate -> sort -> format"
      contains: "def format_pyproject"
    - path: "tests/fixtures/after.toml"
      provides: "Pipeline-generated golden file (fixed point)"
  key_links:
    - from: "src/pyproject_fmt/pipeline.py"
      to: "src/pyproject_fmt/sorter.py"
      via: "import sort_toml"
      pattern: "from pyproject_fmt\\.sorter import"
    - from: "src/pyproject_fmt/pipeline.py"
      to: "src/pyproject_fmt/formatter.py"
      via: "import format_toml"
      pattern: "from pyproject_fmt\\.formatter import"
    - from: "src/pyproject_fmt/sorter.py"
      to: "src/pyproject_fmt/config.py"
      via: "import config objects"
      pattern: "from pyproject_fmt\\.config import"
    - from: "src/pyproject_fmt/formatter.py"
      to: "src/pyproject_fmt/config.py"
      via: "import taplo options"
      pattern: "from pyproject_fmt\\.config import"
---

<objective>
Build the complete sort+format pipeline: hardcoded configuration, toml-sort sorting wrapper, taplo formatting wrapper, and pipeline orchestrator. Add runtime dependencies. Regenerate the golden file from pipeline output to establish a true fixed point.

Purpose: This is the entire formatting engine -- everything downstream (tests, CLI, pre-commit) depends on this pipeline producing correct, deterministic output.
Output: Four Python modules (config.py, sorter.py, formatter.py, pipeline.py), updated pyproject.toml with dependencies, and a regenerated after.toml golden file.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-pipeline/01-RESEARCH.md

# Source files (scaffolds to understand existing structure)
@src/pyproject_fmt/__init__.py
@src/pyproject_fmt/cli.py
@pyproject.toml

# Fixtures
@tests/fixtures/before.toml
@tests/fixtures/after.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config.py with hardcoded defaults and add runtime dependencies</name>
  <files>
    src/pyproject_fmt/config.py
    pyproject.toml
  </files>
  <action>
Create `src/pyproject_fmt/config.py` containing:

1. A function `get_sort_config()` that returns a `SortConfiguration` with ALL locked defaults:
   - `tables=True`, `table_keys=True`, `inline_tables=False`, `inline_arrays=True`, `ignore_case=False`
   - `first` list with EXACT order from research: `["project", "project.*", "build-system", "dependency-groups", "tool.hatch", "tool.git-cliff", "tool.pypis_delivery_service", "tool.uv", "tool.pytest", "tool.coverage", "tool.ty", "tool.ruff", "tool.mypy", "tool.pyright", "tool.basedpyright", "tool.pylint", "tool.isort", "tool.black", "tool.semantic_release", "tool.*", "tool.tomlsort"]`

2. A function `get_sort_overrides()` that returns `dict[str, SortOverrideConfiguration]` with ALL per-table overrides from research:
   - `build-system`: `first=["requires", "build-backend"], inline_arrays=True`
   - `dependency-groups`: `inline_arrays=True`
   - `project`: `inline_arrays=True, first=["name", "version", "description", "readme", "dynamic", "authors", "maintainers", "license", "classifiers", "keywords", "requires-python", "dependencies"]`
   - `tool.pytest`: `inline_arrays=True`
   - `tool.pytest.addopts`: `table_keys=False, inline_arrays=False`
   - `tool.ruff`: `inline_arrays=True`
   - `tool.ruff.*`: `inline_arrays=True`
   - `tool.semantic_release.commit_parser_options`: `inline_arrays=True`
   - `tool.tomlsort`: `table_keys=False, inline_arrays=False`
   - `tool.tomlsort.*`: `table_keys=False, inline_arrays=False`
   - `tool.ty`: `inline_arrays=True`
   - `tool.ty.*`: `inline_arrays=True`

3. A function `get_comment_config()` that returns `CommentConfiguration(header=True, footer=True, inline=True, block=True)`

4. A function `get_format_config()` that returns `FormattingConfiguration(spaces_before_inline_comment=2, spaces_indent_inline_array=4, trailing_comma_inline_array=True)`

5. A list or tuple `TAPLO_OPTIONS` containing the taplo CLI `-o key=value` pairs:
   - `reorder_keys=false`, `indent_string=    ` (4 spaces), `array_auto_collapse=false`, `array_auto_expand=true`, `array_trailing_comma=true`, `align_comments=true`, `column_width=80`, `allowed_blank_lines=2`

Import types from `toml_sort.tomlsort`:
```python
from toml_sort.tomlsort import (
    CommentConfiguration,
    FormattingConfiguration,
    SortConfiguration,
    SortOverrideConfiguration,
)
```

Then update `pyproject.toml` dependencies array to add:
- `"toml-sort>=0.24.0,<0.25"`
- `"taplo>=0.9.0"`

These go in `[project] dependencies` alongside the existing `"typer>=0.12.0"`.

CRITICAL: The `SortConfiguration.inline_arrays=True` sorts array VALUES alphabetically. The `SortOverrideConfiguration.inline_arrays=True` controls array FORMATTING. These are DIFFERENT. Both are needed. Do NOT confuse them.
  </action>
  <verify>
Run: `cd /home/ubuntulinuxqa2/repos/pyproject-fmt && uv sync && uv run python -c "from pyproject_fmt.config import get_sort_config, get_sort_overrides, get_comment_config, get_format_config, TAPLO_OPTIONS; print('config OK')"` -- must print "config OK" with no import errors.
  </verify>
  <done>
config.py exists with all 4 getter functions and TAPLO_OPTIONS. All hardcoded defaults match the locked decisions exactly. toml-sort and taplo are in pyproject.toml dependencies and `uv sync` succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sorter.py, formatter.py, and pipeline.py modules</name>
  <files>
    src/pyproject_fmt/sorter.py
    src/pyproject_fmt/formatter.py
    src/pyproject_fmt/pipeline.py
  </files>
  <action>
Create `src/pyproject_fmt/sorter.py`:
- Function `sort_toml(text: str) -> str` that:
  1. Imports config functions from `pyproject_fmt.config`
  2. Creates a `TomlSort` instance with `input_toml=text`, `sort_config=get_sort_config()`, `comment_config=get_comment_config()`, `format_config=get_format_config()`, `sort_config_overrides=get_sort_overrides()`
  3. Returns `sorter.sorted()`
  4. Import: `from toml_sort import TomlSort`

Create `src/pyproject_fmt/formatter.py`:
- Function `format_toml(text: str) -> str` that:
  1. Imports `TAPLO_OPTIONS` from `pyproject_fmt.config`
  2. Uses `shutil.which("taplo")` to find the binary. Raises `RuntimeError` with install instructions if not found.
  3. Builds command: `[taplo_bin, "format", "--no-auto-config"]` then appends `-o key=value` for each item in `TAPLO_OPTIONS`, then appends `"-"` for stdin.
  4. Calls `subprocess.run(cmd, input=text, capture_output=True, text=True, check=False)`
  5. If `returncode != 0`, raises `RuntimeError` with stderr.
  6. Returns `result.stdout`
  7. CRITICAL: Do NOT use `--quiet` flag (does not exist in taplo 0.10.0). Do NOT use `--force` flag (causes data loss).

Create `src/pyproject_fmt/pipeline.py`:
- Function `format_pyproject(text: str) -> str` that:
  1. Validates input with `tomllib.loads(text)` -- let `TOMLDecodeError` propagate naturally
  2. Calls `sort_toml(text)` to get sorted text
  3. Calls `format_toml(sorted_text)` to get formatted text
  4. Returns formatted text
  5. Imports: `import tomllib`, `from pyproject_fmt.sorter import sort_toml`, `from pyproject_fmt.formatter import format_toml`

All modules must:
- Have module-level docstrings
- Use type annotations on all function signatures
- Follow the pattern: each function is `str -> str` (pure string transformation)
  </action>
  <verify>
Run: `cd /home/ubuntulinuxqa2/repos/pyproject-fmt && uv run python -c "
from pyproject_fmt.pipeline import format_pyproject
result = format_pyproject('[project]\nname = \"test\"\n')
print(repr(result))
assert 'name' in result
print('pipeline OK')
"` -- must print the formatted result and "pipeline OK".

Also verify taplo is available: `which taplo` should return a path.
  </verify>
  <done>
Three modules exist: sorter.py wraps toml-sort, formatter.py wraps taplo subprocess, pipeline.py chains validate->sort->format. A minimal TOML string passes through the full pipeline without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Regenerate golden file from pipeline output</name>
  <files>
    tests/fixtures/after.toml
  </files>
  <action>
The existing `tests/fixtures/after.toml` is NOT a pipeline fixed point (confirmed by research: 675-line diff when pipeline runs on it). It must be regenerated.

1. Run the pipeline on `tests/fixtures/before.toml`:
   ```python
   from pathlib import Path
   from pyproject_fmt.pipeline import format_pyproject

   before = Path("tests/fixtures/before.toml").read_text()
   result = format_pyproject(before)
   ```

2. Verify idempotency: `format_pyproject(result) == result`. If this fails, debug the pipeline configuration alignment between toml-sort and taplo options until idempotency passes. Common causes: `spaces_indent_inline_array` mismatch between toml-sort (4) and taplo (`indent_string=    `), or `trailing_comma_inline_array` mismatch.

3. Verify no TOML data loss: Parse both `before` and `result` with `tomllib.loads()`, then verify all keys and values survive. The table structure and ordering will differ (that's the point), but no key-value pair should be lost.

4. Write the idempotent pipeline output to `tests/fixtures/after.toml`.

5. Run the pipeline on the newly written `after.toml` and confirm the output is byte-for-byte identical to the file content. This proves the golden file IS the pipeline's fixed point.

Execute this as a Python script via `uv run python -c "..."` or a temporary script. The golden file regeneration is a one-time operation that establishes the test baseline.

IMPORTANT: The before.toml is from the claude-linting-hook project (not this project). That's fine -- it's a complex real pyproject.toml that exercises the pipeline's sorting and formatting logic.
  </action>
  <verify>
Run: `cd /home/ubuntulinuxqa2/repos/pyproject-fmt && uv run python -c "
from pathlib import Path
from pyproject_fmt.pipeline import format_pyproject

after = Path('tests/fixtures/after.toml').read_text()
result = format_pyproject(after)
assert result == after, 'Golden file is not a pipeline fixed point'
print('Golden file is idempotent -- pipeline fixed point confirmed')
"` -- must print confirmation message.

Also verify: `wc -l tests/fixtures/after.toml` shows a reasonable number of lines (should be in the 300-500 range for the claude-linting-hook pyproject.toml after formatting).
  </verify>
  <done>
`tests/fixtures/after.toml` contains the pipeline's output from `before.toml`. Running the pipeline on `after.toml` produces byte-identical output (idempotency confirmed). No TOML data loss between before.toml and after.toml (all keys, values, and tables preserved). The golden file is the single source of truth for expected pipeline output.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `uv run python -c "from pyproject_fmt.pipeline import format_pyproject; print('import OK')"` succeeds
2. `uv run python -c "from pyproject_fmt.config import get_sort_config; sc = get_sort_config(); assert sc.first[0] == 'project'; print('config OK')"` succeeds
3. Pipeline produces idempotent output on before.toml
4. Golden file is a pipeline fixed point
5. `uv run ruff check src/pyproject_fmt/` passes (no lint errors in new modules)
</verification>

<success_criteria>
- config.py, sorter.py, formatter.py, pipeline.py all exist and import cleanly
- `format_pyproject(text)` accepts a TOML string and returns sorted+formatted TOML
- `format_pyproject(format_pyproject(text)) == format_pyproject(text)` for before.toml
- after.toml is pipeline-generated and idempotent
- toml-sort and taplo are in pyproject.toml dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-pipeline/01-01-SUMMARY.md`
</output>
